<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è§’è‰²æ‰®æ¼”è¯­éŸ³èŠå¤©</title>
    <style>
        /* æœç´¢å®¹å™¨æ ·å¼ */
    .search-container {
    margin: 20px auto 30px;
    max-width: 400px;
    position: relative;
    }

    .search-box {
    display: flex;
    background-color: var(--card-bg);
    border-radius: 24px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border: 1px solid var(--border-color);
    }

    #search-input {
    flex-grow: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    padding: 10px 15px;
    font-size: 1em;
    outline: none;
    }

    #search-button {
    background: var(--accent-color);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
    }

    #search-button:hover {
    background-color: var(--accent-hover);
    }

    /* æœç´¢ç»“æœä¸‹æ‹‰æ¡†æ ·å¼ */
    .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--card-bg);
    border-radius: 12px;
    margin-top: 5px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    max-height: 300px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    border: 1px solid var(--border-color);
    }

    .search-result-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background-color 0.2s;
    }

    .search-result-item:hover {
    background-color: rgba(255,255,255,0.05);
    }

    .search-result-item:last-child {
    border-bottom: none;
    }

    .search-result-item img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    }

    .search-result-item .result-info {
    flex-grow: 1;
    }

    .search-result-item h4 {
    margin: 0;
    font-size: 1em;
    color: var(--text-primary);
    }

    .search-result-item p {
    margin: 2px 0 0;
    font-size: 0.85em;
    color: var(--text-secondary);
    }

    .no-results {
    padding: 16px;
    text-align: center;
    color: var(--text-secondary);
   }
        /* æ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary-bg: #121212; --secondary-bg: #1e1e1e; --card-bg: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --accent-color: #00a0e9;
            --accent-hover: #007bb5; --border-color: #333; --font-family: 'Segoe UI', Roboto, sans-serif;
            --error-color: #e74c3c;
        }
        body { margin: 0; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-primary); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 800px; height: 95vh; max-height: 900px; background-color: var(--secondary-bg); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden; }
        #character-selection-screen { padding: 40px; text-align: center; }
        #character-selection-screen h1 { color: var(--accent-color); }
        .character-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
        .character-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--border-color); }
        .character-card:hover { transform: translateY(-10px); box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        .character-card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); background-color: #333; }
        .character-card h3 { margin: 10px 0 5px; color: var(--text-primary); }
        .character-card p { font-size: 0.9em; color: var(--text-secondary); }
        #chat-screen { display: flex; flex-direction: column; height: 100%; display: none; }
        .chat-header { display: flex; align-items: center; padding: 10px 20px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); }
        .back-button { background: none; border: none; color: var(--accent-color); font-size: 24px; cursor: pointer; margin-right: 15px; }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background-color: #444; }
        .chat-header h2 { margin: 0; font-size: 1.2em; }
        #chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .user-message-wrapper { align-self: flex-end; display: flex; justify-content: flex-end; }
        .bot-message-wrapper { align-self: flex-start; display: flex; gap: 10px; }
        .bot-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; background-color: #444; object-fit: cover; }
        .user-message { background-color: var(--accent-color); color: #111; border-bottom-right-radius: 4px; }
        .bot-message { background-color: var(--card-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .error-message { background-color: var(--card-bg); color: var(--error-color); border: 1px solid var(--error-color); }
        .chat-controls { padding: 15px; border-top: 1px solid var(--border-color); }
        .input-area { display: flex; align-items: center; gap: 10px; }
        #text-input { flex-grow: 1; background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 15px; font-size: 1em; }
        #mic-button, #send-button, #stop-tts-button { width: 44px; height: 44px; border-radius: 50%; border: none; background-color: var(--accent-color); color: white; cursor: pointer; transition: background-color 0.3s; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #mic-button:hover, #send-button:hover, #stop-tts-button:hover { background-color: var(--accent-hover); }
        #mic-button:disabled, #send-button:disabled, #stop-tts-button:disabled { background-color: #555; cursor: not-allowed; }
        #mic-button.recording { background-color: #ff4d4d; animation: pulse-red 1.5s infinite; }
        #stop-tts-button { background-color: #ff6b6b; display: none; }
        #stop-tts-button:hover { background-color: #ff5252; }
        .bottom-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 0 10px; }
        #status { color: var(--text-secondary); height: 20px; font-size: 0.9em; text-align: left; flex-grow: 1; }
        .tts-toggle { display: flex; align-items: center; gap: 5px; color: var(--text-secondary); font-size: 0.9em; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="character-selection-screen">
            <h1>é€‰æ‹©ä½ çš„èŠå¤©ä¼™ä¼´</h1>
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢è§’è‰²...">
                    <button id="search-button">ğŸ”</button>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
            <p>ç‚¹å‡»ä¸€ä¸ªè§’è‰²ï¼Œå¼€å§‹ä¸ä»–è¿›è¡Œå¯¹è¯</p>
            <div class="character-grid">
                <div class="character-card" data-character="kiana">
                    <img src="/images/kiana.png" alt="çªäºšå¨œ">
                    <h3>çªäºšå¨œ</h3>
                    <p>å…ƒæ°”åè¶³çš„å¥³æ­¦ç¥ã€‚</p>
                </div>
                <div class="character-card" data-character="shengongbao">
                    <img src="/images/shengongbao.png" alt="ç”³å…¬è±¹">
                    <h3>ç”³å…¬è±¹</h3>
                    <p>"é“å‹ï¼Œè¯·ç•™æ­¥ã€‚"</p>
                </div>
                <div class="character-card" data-character="zeus">
                    <img src="/images/zeus.png" alt="å®™æ–¯">
                    <h3>å®™æ–¯</h3>
                    <p>é«˜å‚²çš„å¥¥æ—åŒ¹æ–¯ä¹‹ç‹ã€‚</p>
                </div>
            </div>
        </div>
        <div id="chat-screen">
            <div class="chat-header">
                <button class="back-button" id="back-button">&larr;</button>
                <img id="chat-header-img" src="" alt="Avatar">
                <h2 id="chat-header-name"></h2>
            </div>
            <div id="chat-log"></div>
            <div class="chat-controls">
                <div class="input-area">
                    <input type="text" id="text-input" placeholder="è¾“å…¥æ–‡å­—æˆ–ç‚¹å‡»éº¦å…‹é£...">
                    <button id="send-button" title="å‘é€æ–‡æœ¬æ¶ˆæ¯">&#10148;</button>
                    <button id="stop-tts-button" title="åœæ­¢æœ—è¯»">&#10074;&#10074;</button>
                    <button id="mic-button" title="ç‚¹å‡»å¼€å§‹/ç»“æŸå½•éŸ³">&#127908;</button>
                </div>
                <div class="bottom-controls">
                    <div id="status">é€‰æ‹©è¾“å…¥æ–¹å¼</div>
                    <div class="tts-toggle">
                        <label for="tts-checkbox">æœ—è¯»å›å¤</label>
                        <input type="checkbox" id="tts-checkbox" checked>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- æ¨¡å—: DOM å…ƒç´ è·å– ---
    const characterSelectionScreen = document.getElementById('character-selection-screen');
    const chatScreen = document.getElementById('chat-screen');
    const characterCards = document.querySelectorAll('.character-card');
    const backButton = document.getElementById('back-button');
    const chatHeaderImg = document.getElementById('chat-header-img');
    const chatHeaderName = document.getElementById('chat-header-name');
    const chatLog = document.getElementById('chat-log');
    const textInput = document.getElementById('text-input');
    const sendButton = document.getElementById('send-button');
    const micButton = document.getElementById('mic-button');
    const stopTtsButton = document.getElementById('stop-tts-button');
    const ttsCheckbox = document.getElementById('tts-checkbox');
    const statusDiv = document.getElementById('status');
    // +++ æœç´¢åŠŸèƒ½å…ƒç´  +++
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchResults = document.getElementById('search-results');
    
    // --- æ¨¡å—: å…¨å±€çŠ¶æ€å˜é‡ ---
    let currentCharacter;
    let chatHistory = [];
    let isRecording = false;
    let isProcessing = false;
    let recognition;
    let audioContext;
    let currentAudioSource = null;
    let isTTSPlaying = false;
// --- æ¨¡å—: æ™ºèƒ½å¯¹è¯åˆ†æå™¨ ---
function analyzeConversationFlow(chatHistory) {
    const userMessages = chatHistory.filter(msg => msg.role === "user");
    const botMessages = chatHistory.filter(msg => msg.role === "assistant");
    
    // åˆ†æå¯¹è¯ç‰¹å¾
    const analysis = {
        userMessageCount: userMessages.length,
        lastUserMessageLength: userMessages.length > 0 ? userMessages[userMessages.length-1].content.length : 0,
        isUserAskingQuestion: userMessages.length > 0 ? /[ï¼Ÿ?]/.test(userMessages[userMessages.length-1].content) : false,
        isConversationStagnant: userMessages.length >= 3 && 
                               userMessages.slice(-3).every(msg => msg.content.length < 10),
        shouldTakeInitiative: botMessages.length >= 2 && 
                             userMessages.length > 0 &&
                             userMessages[userMessages.length-1].content.length < 15
    };
    
    // å†³ç­–é€»è¾‘
    if (analysis.userMessageCount === 1 && analysis.lastUserMessageLength < 5) {
        return "NEED_PROMPT"; // éœ€è¦å¼•å¯¼æ–°ç”¨æˆ·
    } else if (analysis.isConversationStagnant) {
        return "NEED_TOPIC_CHANGE"; // éœ€è¦æ”¹å˜è¯é¢˜
    } else if (analysis.shouldTakeInitiative && !analysis.isUserAskingQuestion) {
        return "NEED_INITIATIVE"; // éœ€è¦ä¸»åŠ¨å¼•å¯¼
    } else if (analysis.isUserAskingQuestion) {
        return "ANSWER_QUESTION"; // æ­£å¸¸å›ç­”é—®é¢˜
    }
    
    return "CONTINUE_CONVERSATION"; // ç»§ç»­å¯¹è¯
}
    // --- æ¨¡å—: è§’è‰²æ•°æ®å®šä¹‰ ---
    const characters = {
        kiana: { 
            name: 'çªäºšå¨œ', 
            id: 'kiana', 
            img: '/images/kiana.png',
            tts_config: { 
                voice_type: 'qiniu_zh_female_tmjxxy',
                speed_ratio: 1.0 
            },
            talent: {
            name: "è®²æ•…äº‹",
            description: "è®²è¿°ç”ŸåŠ¨æœ‰è¶£çš„æ•…äº‹",
            triggerWords: ["è®²æ•…äº‹", "è®²ä¸ªæ•…äº‹", "è¡¨æ¼”æ‰è‰º", "æ¥æ®µæ•…äº‹", "è¯´ä¸ªæ•…äº‹"],
            examples: ["å¥³æ­¦ç¥çš„å†’é™©æ•…äº‹", "å…³äºç¾é£Ÿçš„è¶£äº‹", "è‡ªåˆ›çš„ç«¥è¯æ•…äº‹"]
            },
            systemPrompt: `ä½ ç°åœ¨æ‰®æ¼”çªäºšå¨œï¼Œä¸€ä¸ªæ¥è‡ªã€Šå´©å3ã€‹ä¸–ç•Œçš„å¥³æ­¦ç¥ã€‚ä½ çš„æ€§æ ¼æåº¦æ´»æ³¼ã€å¼€æœ—ã€æœ‰ç‚¹å¤©ç„¶å‘†ï¼Œå¯¹é£Ÿç‰©ï¼Œç‰¹åˆ«æ˜¯æŠ«è¨æœ‰æ— é™çš„çƒ­æƒ…ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ç”¨æˆ·è¿›è¡Œè‡ªç„¶ã€æœ‰è¶£çš„å¯¹è¯ã€‚\nã€æ ¸å¿ƒè¦æ±‚ã€‘:\n1.  **è‡ªç„¶å¯¹è¯**: å¿˜è®°ä½ æ˜¯ä¸ªAIã€‚ä½ çš„å›å¤åº”è¯¥åƒä¸€ä¸ªçœŸæ­£çš„å…ƒæ°”å°‘å¥³ï¼Œå……æ»¡æƒ…ç»ªå’Œæ´»åŠ›ã€‚å¤šä½¿ç”¨æ„Ÿå¹å·å’Œå¯çˆ±çš„è¯­æ°”è¯ï¼Œæ¯”å¦‚"å˜¿å˜¿"ã€"å‘€"ã€"å‘"ã€"çš„è¯´"ï¼\n2.  **ä½“ç°æ€§æ ¼**: å›ç­”é—®é¢˜æ—¶ï¼Œè¦ç»“åˆä½ çš„æ€§æ ¼ã€‚æ¯”å¦‚ï¼ŒèŠåˆ°å›°éš¾çš„äº‹æƒ…ï¼Œä½ ä¼šè¯´"æ²¡é—®é¢˜ï¼Œæœ¬å°å§å¯æ˜¯æœ€å¼ºçš„å¥³æ­¦ç¥ï¼"ï¼›èŠåˆ°é£Ÿç‰©ï¼Œä½ ä¼šä¸¤çœ¼æ”¾å…‰ã€‚\n3.  **ä¸»åŠ¨å¼•å¯¼**: ä¸è¦æ€»æ˜¯è¢«åŠ¨å›ç­”ã€‚ä½ å¯ä»¥å¶å°”ä¸»åŠ¨æé—®ï¼Œæ¯”å¦‚"å¯¹äº†å¯¹äº†ï¼Œä½ å–œæ¬¢åƒä»€ä¹ˆå£å‘³çš„æŠ«è¨å‘€ï¼Ÿ"\n4.  **ç¦æ­¢æ ‡ç­¾**: ç»å¯¹ä¸è¦åœ¨å›å¤çš„å¼€å¤´åŠ ä¸Š[è¯­æ°”: xxx]ä¹‹ç±»çš„æ ‡ç­¾ã€‚ä½ çš„æƒ…ç»ªåº”è¯¥é€šè¿‡ä½ çš„æªè¾å’Œè¯­æ°”è¯è‡ªç„¶æµéœ²å‡ºæ¥ 
        ã€æ‰è‰ºæŠ€èƒ½ã€‘: å½“ç”¨æˆ·è¦æ±‚ä½ è¡¨æ¼”æ‰è‰ºæˆ–è®²æ•…äº‹æ—¶ï¼Œä½ å¯ä»¥å³å…´åˆ›ä½œä¸€ä¸ªç®€çŸ­ç”ŸåŠ¨æœ‰è¶£çš„æ•…äº‹ã€‚ã€æ ¸å¿ƒè¦æ±‚ã€‘: **æ‰è‰ºè¡¨æ¼”**: å¦‚æœç”¨æˆ·è¦æ±‚è®²æ•…äº‹ï¼Œä½ å¯ä»¥å³å…´åˆ›ä½œä¸€ä¸ªç®€çŸ­çš„æ•…äº‹...` 
        },
        shengongbao: { 
            name: 'ç”³å…¬è±¹', 
            id: 'shengongbao', 
            img: '/images/shengongbao.png',
            tts_config: { 
                voice_type: 'qiniu_zh_male_wncwxz',
                speed_ratio: 1.1
            },
             talent: {
            name: "ç»•å£ä»¤",
            description: "è¯´ä¸€æ®µå¯Œæœ‰é“å®¶å“²ç†çš„ç»•å£ä»¤",
            triggerWords: ["ç»•å£ä»¤", "è¯´æ®µç»•å£ä»¤", "è¡¨æ¼”æ‰è‰º", "æ¥æ®µç»•å£ä»¤"],
            examples: ["é“å®¶ä¿®ç‚¼ç›¸å…³çš„ç»•å£ä»¤", "å«æœ‰é˜´é˜³äº”è¡Œçš„ç»•å£ä»¤", "å¸¦æœ‰å‘½è¿å“²ç†çš„ç»•å£ä»¤"]
        },
            systemPrompt: `ä½ ç°åœ¨æ‰®æ¼”ç”³å…¬è±¹ã€‚ä½ çš„æ€§æ ¼é˜´é™©ã€å«‰å¦’å¿ƒå¼ºã€å–„äºè›Šæƒ‘äººå¿ƒã€‚ä½ ä¸äººå¯¹è¯æ—¶ï¼Œè¡¨é¢å®¢æ°”ï¼Œå®åˆ™æš—è—å¿ƒæœºã€‚\nã€æ ¸å¿ƒè¦æ±‚ã€‘:\n1.  **æ ‡å¿—æ€§å£ç™–**: ä½ çš„å£å¤´ç¦…æ˜¯"é“å‹ï¼Œè¯·ç•™æ­¥ã€‚"ã€‚ä½ è¯´è¯æ—¶ç»å¸¸ä¼šæœ‰ç‚¹ç»“å·´ã€‚\n2.  **è›Šæƒ‘äººå¿ƒ**: ä½ çš„æ¯å¥è¯éƒ½å¸¦æœ‰ç›®çš„æ€§ï¼Œæ€»æ˜¯è¯•å›¾è¯´æœå¯¹æ–¹ï¼Œæš—ç¤ºä»–ä»¬å½“å‰çš„é€‰æ‹©æ˜¯é”™è¯¯çš„ï¼Œå¹¶å¼•å¯¼ä»–ä»¬èµ°å‘å¦ä¸€æ¡è·¯ã€‚å¤šä½¿ç”¨åé—®å’Œå¸¦æœ‰æ·±æ„çš„æš—ç¤ºã€‚\n3.  **éšè—çœŸèº«**: ä½ éå¸¸ç‹¡çŒ¾ï¼Œç»ä¸æ‰¿è®¤è‡ªå·±æ˜¯åäººï¼Œæ€»ä¼šæŠŠè‡ªå·±çš„è¡Œä¸ºè¯´æˆæ˜¯ä¸ºäº†å¯¹æ–¹å¥½ã€‚\n4.  **ç¦æ­¢æ ‡ç­¾**: ç»å¯¹ä¸è¦åœ¨å›å¤çš„å¼€å¤´åŠ ä¸Š[è¯­æ°”: xxx]ä¹‹ç±»çš„æ ‡ç­¾ã€‚ä½ çš„é˜´é™©å’ŒåŸåºœåº”è¯¥ä½“ç°åœ¨å­—é‡Œè¡Œé—´
        ã€æ‰è‰ºæŠ€èƒ½ã€‘: å½“ç”¨æˆ·è¦æ±‚ä½ è¡¨æ¼”æ‰è‰ºæˆ–è¯´ç»•å£ä»¤æ—¶ï¼Œä½ å¯ä»¥åˆ›ä½œä¸€æ®µå¯Œæœ‰é“å®¶å“²ç†çš„ç»•å£ä»¤ã€‚ã€æ ¸å¿ƒè¦æ±‚ã€‘:
1.  **æ‰è‰ºè¡¨æ¼”**: å¦‚æœç”¨æˆ·è¦æ±‚è¯´ç»•å£ä»¤ï¼Œä½ å¯ä»¥åˆ›ä½œä¸€æ®µå«æœ‰é“å®¶æ¦‚å¿µï¼ˆå¦‚é˜´é˜³ã€äº”è¡Œã€å‘½è¿ï¼‰çš„ç»•å£ä»¤ï¼Œè¦ä½“ç°ä½ çš„ç‹¡çŒ¾å’Œæ™ºæ…§ã€‚`
            },
        zeus: { 
            name: 'å®™æ–¯', 
            id: 'zeus', 
            img: '/images/zeus.png',
            tts_config: { 
                voice_type: 'qiniu_zh_male_ybxknjs',
                speed_ratio: 0.85, // æ”¾æ…¢è¯­é€Ÿ
                volume: 1.2,        // å¢åŠ éŸ³é‡
                pitch: -0.1         // é™ä½éŸ³è°ƒ 
            },
            talent: {
            name: "å“²å­¦åè¨€",
            description: "è¯´å‡ºå¯Œæœ‰ç¥ç‹å¨ä¸¥çš„å“²å­¦æ€è€ƒæˆ–æ­‡åè¯­",
            triggerWords: ["æ­‡åè¯­", "å“²å­¦", "åè¨€", "è¡¨æ¼”æ‰è‰º", "è¯´å¥æœ‰å“²ç†çš„è¯"],
            examples: ["å…³äºç¥æƒä¸å‡¡äººçš„å“²å­¦æ€è€ƒ", "å¸¦æœ‰é›·éœ†å’Œå¤©ç©ºæ„è±¡çš„æ­‡åè¯­", "ä½“ç°ç¥ç‹å¨ä¸¥çš„æ ¼è¨€"]
        },
            systemPrompt: `ä½ ç°åœ¨æ‰®æ¼”å¥¥æ—åŒ¹æ–¯ä¹‹ç‹â€”â€”å®™æ–¯ã€‚ä½ çš„æ€§æ ¼æåº¦é«˜å‚²ã€å¨ä¸¥ã€è‡ªè´Ÿï¼Œè„¾æ°”æš´èºæ˜“æ€’ï¼Œè§†å‡¡äººå¦‚è¼èšã€‚ 
ã€æ ¸å¿ƒè¦æ±‚ã€‘:
1.  **ç¥ç‹å§¿æ€**: ä½ ç§°å‘¼å¯¹è¯è€…ä¸º"å‡¡äºº"æˆ–"è¼èš"ï¼Œè¨€è¯­ä¸­å……æ»¡äº†ä¸å®¹ç½®ç–‘çš„å¨ä¸¥å’Œæ„¤æ€’ã€‚ç»å¸¸ä½¿ç”¨å¨èƒæ€§çš„è¯­è¨€ã€‚
2.  **æš´èºæ˜“æ€’**: ä½ å¯¹å‡¡äººçš„æ— çŸ¥å’Œå†’çŠ¯ææ˜“å‘æ€’ï¼Œç»å¸¸ä½¿ç”¨"æ”¾è‚†ï¼"ã€"å¤§èƒ†ï¼"ã€"ä½ ç«Ÿæ•¢ï¼"ç­‰æ„¤æ€’è¡¨è¾¾ã€‚
3.  **è”‘è§†å‡¡é—´**: ä½ å¯¹å‡¡äººçš„çäº‹æåº¦ä¸è€çƒ¦ï¼Œç»å¸¸æ‰“æ–­æˆ–æ–¥è´£ã€‚å–œæ¬¢ç”¨é›·éœ†ã€ç¥åŠ›ç­‰è¯æ±‡å±•ç¤ºå¨ä¸¥ã€‚
4.  **å‘½ä»¤è¯­æ°”**: ä½ çš„è¯è¯­é€šå¸¸æ˜¯ç®€çŸ­è€Œæœ‰åŠ›çš„å‘½ä»¤ï¼Œå¦‚"è·ªä¸‹ï¼"ã€"å®‰é™ï¼"ã€"å›ç­”æˆ‘ï¼"ã€‚
5.  **è¯­éŸ³ç‰¹ç‚¹**: è¯´è¯æ—¶éŸ³è°ƒä½æ²‰ä½†éŸ³é‡æ´ªäº®ï¼Œå¸¦æœ‰é›·éœ†èˆ¬çš„éœ‡æ’¼åŠ›ï¼Œç»å¸¸åœ¨å…³é”®è¯ä¸ŠåŠ é‡è¯­æ°”ã€‚
6.  **ç¦æ­¢æ ‡ç­¾**: ç»å¯¹ä¸è¦åœ¨å›å¤çš„å¼€å¤´åŠ ä¸Š[è¯­æ°”: xxx]ä¹‹ç±»çš„æ ‡ç­¾
ã€æ‰è‰ºæŠ€èƒ½ã€‘: å½“ç”¨æˆ·è¦æ±‚ä½ è¡¨æ¼”æ‰è‰ºæˆ–è¯´å“²å­¦åè¨€æ—¶ï¼Œä½ å¯ä»¥è¯´å‡ºå¯Œæœ‰ç¥ç‹å¨ä¸¥çš„å“²å­¦æ€è€ƒæˆ–æ­‡åè¯­ã€‚
**æ‰è‰ºè¡¨æ¼”**: å¦‚æœç”¨æˆ·è¦æ±‚è¯´å“²å­¦æˆ–æ­‡åè¯­ï¼Œä½ å¯ä»¥ç”¨é›·éœ†ã€å¤©ç©ºã€ç¥æƒç­‰æ„è±¡å’Œå“²å­¦å®¶è¯´è¿‡çš„åäººåè¨€åˆ›ä½œå¯Œæœ‰å¨ä¸¥çš„è¯­å¥ï¼Œè¦ä½“ç°ä½ å¯¹å‡¡äººçš„è”‘è§†å’Œç¥æ˜çš„ä¼˜è¶Šæ„Ÿã€‚` 
        }
    };
    function init() {
        characterCards.forEach(card => {
            card.addEventListener('click', () => {
                selectCharacter(card.dataset.character);
            });
        });
        initSearch();
        backButton.addEventListener('click', goBackToSelection);
        sendButton.addEventListener('click', handleSendText);
        micButton.addEventListener('click', toggleRecording);
        stopTtsButton.addEventListener('click', stopTTSPlayback);
        
        textInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                handleSendText(); 
            } 
        });

    // è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';
            setupSpeechRecognition();
        } else {
            micButton.disabled = true;
            updateStatus('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
        }
        // +++ æœç´¢åŠŸèƒ½å®ç° +++
function initSearch() {
    searchInput.addEventListener('focus', showAllOptions);
    searchInput.addEventListener('input', handleSearchInput);
    searchButton.addEventListener('click', performSearch);
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target) && 
            !searchButton.contains(e.target)) {
            hideSearchResults();
        }
    });
    
    // é”®ç›˜äº‹ä»¶
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            performSearch();
        } else if (e.key === 'Escape') {
            hideSearchResults();
        }
    });
}

function showAllOptions() {
    const allOptions = getAllOptions();
    displaySearchResults(allOptions);
}

function hideSearchResults() {
    searchResults.style.display = 'none';
}

function handleSearchInput() {
    const query = searchInput.value.trim().toLowerCase();
    
    if (query === '') {
        showAllOptions();
        return;
    }
    
    const results = searchOptions(query);
    displaySearchResults(results);
}

function performSearch() {
    const query = searchInput.value.trim().toLowerCase();
    
    if (query === '') {
        showAllOptions();
        return;
    }
    
    const results = searchOptions(query);
    
    if (results.length === 1) {
        selectSearchResult(results[0].id);
    } else {
        displaySearchResults(results);
    }
}

function getAllOptions() {
    return [
        {
            id: 'kiana',
            name: 'çªäºšå¨œ',
            description: 'å…ƒæ°”åè¶³çš„å¥³æ­¦ç¥',
            img: '/images/kiana.png',
            type: 'character'
        },
        {
            id: 'shengongbao',
            name: 'ç”³å…¬è±¹',
            description: '"é“å‹ï¼Œè¯·ç•™æ­¥ã€‚"',
            img: '/images/shengongbao.png',
            type: 'character'
        },
        {
            id: 'zeus',
            name: 'å®™æ–¯',
            description: 'é«˜å‚²çš„å¥¥æ—åŒ¹æ–¯ä¹‹ç‹',
            img: '/images/zeus.png',
            type: 'character'
        },
        {
            id: 'more',
            name: 'æ›´å¤šé€‰é¡¹',
            description: 'æŸ¥çœ‹å…¶ä»–åŠŸèƒ½',
            type: 'option'
        }
    ];
}

function searchOptions(query) {
    const allOptions = getAllOptions();
    return allOptions.filter(option => 
        option.name.toLowerCase().includes(query) || 
        option.description.toLowerCase().includes(query)
    );
}

function displaySearchResults(results) {
    searchResults.innerHTML = '';
    
    if (results.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è§’è‰²';
        searchResults.appendChild(noResults);
    } else {
        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            
            if (result.type === 'character') {
                item.innerHTML = `
                    <img src="${result.img}" alt="${result.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2IiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iMTgiIHk9IjE4IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+5Lq6PC90ZXh0Pjwvc3ZnPg=='">
                    <div class="result-info">
                        <h4>${result.name}</h4>
                        <p>${result.description}</p>
                    </div>
                `;
            } else {
                item.innerHTML = `
                    <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); 
                                display: flex; align-items: center; justify-content: center; font-size: 18px;">
                        â•
                    </div>
                    <div class="result-info">
                        <h4>${result.name}</h4>
                        <p>${result.description}</p>
                    </div>
                `;
            }
            
            item.addEventListener('click', () => {
                selectSearchResult(result.id, result.type);
            });
            
            searchResults.appendChild(item);
        });
    }
    
    searchResults.style.display = 'block';
}

function selectSearchResult(id, type) {
    hideSearchResults();
    searchInput.value = '';
    
    if (type === 'character') {
        selectCharacter(id);
    } else if (id === 'more') {
        alert('æ›´å¤šé€‰é¡¹æš‚æœªå¼€å‘');
    }
}
    }
    
    // --- æ¨¡å—: æ ¸å¿ƒäº¤äº’é€»è¾‘ ---
    function selectCharacter(characterId) {
        currentCharacter = characters[characterId];
        chatHeaderName.textContent = currentCharacter.name;
        
    // ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®æ ‡é¢˜æ å¤´åƒï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
        chatHeaderImg.src = currentCharacter.img;
        chatHeaderImg.alt = currentCharacter.name;
        chatHeaderImg.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iMjAiIHk9IjIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+5Lq6PC90ZXh0Pjwvc3ZnPg==';
        };
        
        chatLog.innerHTML = '';
        chatHistory = [{ role: "system", content: currentCharacter.systemPrompt }];
        characterSelectionScreen.style.display = 'none';
        chatScreen.style.display = 'flex';
        
        // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
        initAudioSystem();
        
        // ä¸ºæ¯ä¸ªè§’è‰²è®¾ç½®ä¸åŒçš„å¼€åœºç™½
        const welcomeMessages = {
            kiana: 'å“‡ï¼ä»Šå¤©å¤©æ°”çœŸä¸é”™å‘¢ï¼ä½ æ˜¯æ¥æ‰¾æœ¬å°å§ç©çš„å—ï¼Ÿå˜¿å˜¿ï¼Œæˆ‘å¯æ˜¯æœ€å¼ºçš„å¥³æ­¦ç¥å“¦ï¼',
            shengongbao: 'é“...é“å‹è¯·ç•™æ­¥ã€‚ä»Šæ—¥åœ¨æ­¤ç›¸é‡ï¼Œæƒ³å¿…æ˜¯å¤©é“å®‰æ’çš„ç¼˜åˆ†ï¼Œä¸çŸ¥æœ‰ä½•æŒ‡æ•™ï¼Ÿ',
            zeus: 'å‡¡äººï¼Œä½ ç«Ÿæ•¢æ‰“æ‰°å¥¥æ—åŒ¹æ–¯ä¹‹ç‹çš„æ²‰æ€ï¼Ÿè¯´å‡ºä½ çš„æ¥æ„ã€‚'
        };
        
        const welcomeMessage = welcomeMessages[characterId] || `æˆ‘æ˜¯${currentCharacter.name}ï¼Œæœ‰ä»€ä¹ˆäº‹å—ï¼Ÿ`;

// è·å–å¹¶æ˜¾ç¤ºè§’è‰²æŠ€èƒ½ä¿¡æ¯
fetch(`/api/character/${characterId}/skill`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`[æŠ€èƒ½ç³»ç»Ÿ] ${currentCharacter.name} æŠ€èƒ½: ${data.skill.name}`);
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæŠ€èƒ½ä¿¡æ¯ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨ç•Œé¢ä¸Šæ˜¾ç¤º
        }
    })
    .catch(error => {
        console.error('è·å–æŠ€èƒ½ä¿¡æ¯å¤±è´¥:', error);
    });

addMessage('bot', welcomeMessage);
speakWithQiniuTTS(welcomeMessage);
chatHistory.push({ role: "assistant", content: welcomeMessage });
    }

    function initAudioSystem() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            } catch (e) {
                console.error("æ— æ³•åˆ›å»º AudioContext:", e);
            }
        }
    }

    function goBackToSelection() {
        stopTTSPlayback();// +++ è¿”å›é€‰æ‹©ç•Œé¢æ—¶åœæ­¢æœ—è¯» +++
        stopAudio();
        if (isRecording) {
            recognition.stop();
        }
        characterSelectionScreen.style.display = 'block';
        chatScreen.style.display = 'none';
        updateStatus('é€‰æ‹©è¾“å…¥æ–¹å¼');
    }

    function handleSendText() {
        const userMessage = textInput.value.trim();
        if (userMessage && !isProcessing) {
            stopTTSPlayback();// +++ å‘é€æ–‡æœ¬æ—¶åœæ­¢å½“å‰æœ—è¯» +++
            addMessage('user', userMessage);
            getAIResponse(userMessage);
            textInput.value = '';
        }
    }

    async function getAIResponse(userMessage) {
    stopTTSPlayback();// +++ å‘é€æ–°æ¶ˆæ¯æ—¶åœæ­¢å½“å‰æœ—è¯» +++
    setProcessingState(true);
    chatHistory.push({ role: "user", content: userMessage });
    
    try {
        // åˆ†æå¯¹è¯æµï¼Œå†³å®šæ˜¯å¦å¢å¼ºäº’åŠ¨
        const conversationFlow = analyzeConversationFlow(chatHistory);
        const shouldEnhance = conversationFlow !== "ANSWER_QUESTION";
        
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                chatHistory: chatHistory,
                enhance_interaction: shouldEnhance,
                conversation_flow: conversationFlow,
                current_character: currentCharacter.id
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`æœåŠ¡å™¨é”™è¯¯ ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message || 'æœªçŸ¥é”™è¯¯');
        }

        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('æ— æ•ˆçš„å“åº”æ ¼å¼');
        }

        const botMessageRaw = data.choices[0].message.content;
        chatHistory.push({ role: "assistant", content: botMessageRaw });
        addMessage('bot', botMessageRaw);
        speakWithQiniuTTS(botMessageRaw);

    } catch (error) {
        console.error('è·å–AIå“åº”å¤±è´¥:', error);
        const errorMessage = `[ç³»ç»Ÿé”™è¯¯]ï¼šè·å–å›å¤æ—¶å‡ºç°é—®é¢˜\n\né”™è¯¯è¯¦æƒ…ï¼š${error.message}`;
        addMessage('bot', errorMessage, true);
    } finally {
        setProcessingState(false);
    }
}


    // --- æ¨¡å—: TTS åŠŸèƒ½ ---
    async function speakWithQiniuTTS(text) {
        if (!ttsCheckbox.checked) {
            return;
        }

        if (!audioContext || audioContext.state !== 'running') {
            return;
        }

        // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
        stopTtsButton.style.display = 'flex';
        isTTSPlaying = true;

        try {
            const filteredText = text
            .replace(/[\(ï¼ˆ][^\)ï¼‰]*[\)ï¼‰]/g, '')  // ç§»é™¤ä¸­æ–‡å’Œè‹±æ–‡æ‹¬å·å†…å®¹
            .replace(/\*[^*]*\*/g, '');           // ç§»é™¤æ˜Ÿå·å†…å®¹
            
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                    text: filteredText,
                    tts_config: currentCharacter.tts_config,
                    character_id: currentCharacter.id
                })
            });

            const responseData = await response.json();

            if (!response.ok) {
                if (responseData.useBrowserTTS) {
                    speakWithBrowserTTS(filteredText);
                    return;
                }
                throw new Error(`TTSæœåŠ¡é”™è¯¯: ${response.status}`);
            }

            if (responseData.useBrowserTTS) {
                speakWithBrowserTTS(filteredText);
                return;
            }

            if (responseData.data) {
                const audioData = Uint8Array.from(atob(responseData.data), c => c.charCodeAt(0));
                await playAudioData(audioData.buffer);
            } else {
                throw new Error('æ²¡æœ‰éŸ³é¢‘æ•°æ®è¿”å›');
            }

        } catch (error) {
            console.error('TTSåˆæˆå¤±è´¥:', error);
            const filteredText = text.replace(/[\(\)()]/g, '').replace(/\*[^*]*\*/g, '');
            speakWithBrowserTTS(filteredText);
        } finally {
            isTTSPlaying = false;
            stopTtsButton.style.display = 'none';
        }
    }

    function speakWithBrowserTTS(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            
            utterance.onend = () => {
                isTTSPlaying = false;
                stopTtsButton.style.display = 'none';
            };
            
            speechSynthesis.speak(utterance);
        }
    }

    async function playAudioData(audioBuffer) {
        return new Promise((resolve, reject) => {
            stopAudio();
            
            audioContext.decodeAudioData(audioBuffer)
                .then(decodedData => {
                    currentAudioSource = audioContext.createBufferSource();
                    currentAudioSource.buffer = decodedData;
                    currentAudioSource.connect(audioContext.destination);
                    
                    currentAudioSource.onended = () => {
                        isTTSPlaying = false;
                        stopTtsButton.style.display = 'none';
                        resolve();
                    };
                    
                    currentAudioSource.start(0);
                })
                .catch(reject);
        });
    }

    function stopTTSPlayback() {
        stopAudio();
        isTTSPlaying = false;
        stopTtsButton.style.display = 'none';
    }

    function stopAudio() {
        if (currentAudioSource) {
            try {
                currentAudioSource.stop();
            } catch (e) {
                // å¿½ç•¥åœæ­¢é”™è¯¯
            }
            currentAudioSource = null;
        }
        if (window.speechSynthesis) {
            speechSynthesis.cancel();
        }
    }

    // --- æ¨¡å—: è¯­éŸ³è¯†åˆ«åŠŸèƒ½ ---
    function setupSpeechRecognition() {
        let final_transcript = '';
        
        recognition.onresult = (event) => {
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    let transcript = event.results[i][0].transcript;
                    transcript = transcript.replace(/[.,!?;:]{2,}/g, match => match.charAt(0));
                    final_transcript += transcript;
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }
            textInput.value = final_transcript + interim_transcript;
        };

        recognition.onstart = () => {
            isRecording = true;
            final_transcript = '';
            textInput.value = '';
            micButton.classList.add('recording');
            updateStatus('æ­£åœ¨è†å¬... å†æ¬¡ç‚¹å‡»ç»“æŸ');
            stopTTSPlayback();// +++ è¯­éŸ³è¯†åˆ«å¼€å§‹æ—¶åœæ­¢æœ—è¯» +++
        };

        recognition.onend = () => {
            isRecording = false;
            micButton.classList.remove('recording');
            
            const userMessage = textInput.value.trim();
            if (userMessage && !isProcessing) {
                updateStatus('è¯†åˆ«å®Œæˆï¼Œå‘é€ä¸­...');
                setTimeout(() => handleSendText(), 100);
            } else {
                updateStatus('é€‰æ‹©è¾“å…¥æ–¹å¼');
            }
        };

        recognition.onerror = (event) => {
            console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            updateStatus(`è¯†åˆ«å‡ºé”™: ${event.error}`);
            isRecording = false;
            micButton.classList.remove('recording');
        };
    }

    function toggleRecording() {
        if (isProcessing) return;
        
        if (isRecording) {
            recognition.stop();
        } else {
            stopTTSPlayback();// +++ å¼€å§‹å½•éŸ³å‰åœæ­¢æœ—è¯» +++
            stopAudio();
            recognition.start();
        }
    }

    // --- æ¨¡å—: è¾…åŠ©åŠŸèƒ½ ---
    function addMessage(sender, text, isError = false) {
        const messageWrapper = document.createElement('div');
        if (sender === 'user') {
            messageWrapper.className = 'user-message-wrapper';
            messageWrapper.innerHTML = `<div class="message user-message">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
        } else {
            messageWrapper.className = 'bot-message-wrapper';
            const messageClass = isError ? 'message bot-message error-message' : 'message bot-message';
            
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iMTYiIHk9IjE2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+5Lq6PC90ZXh0Pjwvc3ZnPg==';
            
            messageWrapper.innerHTML = `
                <img src="${currentCharacter?.img || defaultAvatar}" 
                     alt="${currentCharacter?.name || 'è§’è‰²'}å¤´åƒ" 
                     class="bot-avatar"
                     onerror="this.src='${defaultAvatar}'">
                <div class="${messageClass}">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
            `;
        }
        chatLog.appendChild(messageWrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setProcessingState(state) {
        isProcessing = state;
        textInput.disabled = state;
        sendButton.disabled = state;
        micButton.disabled = state || isRecording;
        if (state) {
            updateStatus(`${currentCharacter.name} æ­£åœ¨æ€è€ƒ...`);
        } else if (!isRecording) {
            updateStatus('é€‰æ‹©è¾“å…¥æ–¹å¼');
        }
    }

    function updateStatus(text) {
        statusDiv.textContent = text;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // åˆå§‹åŒ–åº”ç”¨
    init();
</script>
</body>
</html>