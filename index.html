<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 角色扮演语音聊天</title>
    <style>
        /* 样式保持不变 */
        :root {
            --primary-bg: #121212; --secondary-bg: #1e1e1e; --card-bg: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --accent-color: #00a0e9;
            --accent-hover: #007bb5; --border-color: #333; --font-family: 'Segoe UI', Roboto, sans-serif;
            --error-color: #e74c3c;
        }
        body { margin: 0; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-primary); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 800px; height: 95vh; max-height: 900px; background-color: var(--secondary-bg); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden; }
        #character-selection-screen { padding: 40px; text-align: center; }
        #character-selection-screen h1 { color: var(--accent-color); }
        .character-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
        .character-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--border-color); }
        .character-card:hover { transform: translateY(-10px); box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        .character-card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); background-color: #333; }
        .character-card h3 { margin: 10px 0 5px; color: var(--text-primary); }
        .character-card p { font-size: 0.9em; color: var(--text-secondary); }
        #chat-screen { display: flex; flex-direction: column; height: 100%; display: none; }
        .chat-header { display: flex; align-items: center; padding: 10px 20px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); }
        .back-button { background: none; border: none; color: var(--accent-color); font-size: 24px; cursor: pointer; margin-right: 15px; }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background-color: #444; }
        .chat-header h2 { margin: 0; font-size: 1.2em; }
        #chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .user-message-wrapper { align-self: flex-end; display: flex; justify-content: flex-end; }
        .bot-message-wrapper { align-self: flex-start; display: flex; gap: 10px; }
        .bot-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; background-color: #444; object-fit: cover; }
        .user-message { background-color: var(--accent-color); color: #111; border-bottom-right-radius: 4px; }
        .bot-message { background-color: var(--card-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .error-message { background-color: var(--card-bg); color: var(--error-color); border: 1px solid var(--error-color); }
        .chat-controls { padding: 15px; border-top: 1px solid var(--border-color); }
        .input-area { display: flex; align-items: center; gap: 10px; }
        #text-input { flex-grow: 1; background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 15px; font-size: 1em; }
        #mic-button, #send-button, #stop-tts-button { width: 44px; height: 44px; border-radius: 50%; border: none; background-color: var(--accent-color); color: white; cursor: pointer; transition: background-color 0.3s; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #mic-button:hover, #send-button:hover, #stop-tts-button:hover { background-color: var(--accent-hover); }
        #mic-button:disabled, #send-button:disabled, #stop-tts-button:disabled { background-color: #555; cursor: not-allowed; }
        #mic-button.recording { background-color: #ff4d4d; animation: pulse-red 1.5s infinite; }
        #stop-tts-button { background-color: #ff6b6b; display: none; }
        #stop-tts-button:hover { background-color: #ff5252; }
        .bottom-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 0 10px; }
        #status { color: var(--text-secondary); height: 20px; font-size: 0.9em; text-align: left; flex-grow: 1; }
        .tts-toggle { display: flex; align-items: center; gap: 5px; color: var(--text-secondary); font-size: 0.9em; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="character-selection-screen">
            <h1>选择你的聊天伙伴</h1>
            <p>点击一个角色，开始与他进行对话</p>
            <div class="character-grid">
                <div class="character-card" data-character="kiana">
                    <img src="/images/kiana.png" alt="琪亚娜">
                    <h3>琪亚娜</h3>
                    <p>元气十足的女武神。</p>
                </div>
                <div class="character-card" data-character="shengongbao">
                    <img src="/images/shengongbao.png" alt="申公豹">
                    <h3>申公豹</h3>
                    <p>"道友，请留步。"</p>
                </div>
                <div class="character-card" data-character="zeus">
                    <img src="/images/zeus.png" alt="宙斯">
                    <h3>宙斯</h3>
                    <p>高傲的奥林匹斯之王。</p>
                </div>
            </div>
        </div>
        <div id="chat-screen">
            <div class="chat-header">
                <button class="back-button" id="back-button">&larr;</button>
                <img id="chat-header-img" src="" alt="Avatar">
                <h2 id="chat-header-name"></h2>
            </div>
            <div id="chat-log"></div>
            <div class="chat-controls">
                <div class="input-area">
                    <input type="text" id="text-input" placeholder="输入文字或点击麦克风...">
                    <button id="send-button" title="发送文本消息">&#10148;</button>
                    <button id="stop-tts-button" title="停止朗读">&#10074;&#10074;</button>
                    <button id="mic-button" title="点击开始/结束录音">&#127908;</button>
                </div>
                <div class="bottom-controls">
                    <div id="status">选择输入方式</div>
                    <div class="tts-toggle">
                        <label for="tts-checkbox">朗读回复</label>
                        <input type="checkbox" id="tts-checkbox" checked>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- 模块: DOM 元素获取 ---
    const characterSelectionScreen = document.getElementById('character-selection-screen');
    const chatScreen = document.getElementById('chat-screen');
    const characterCards = document.querySelectorAll('.character-card');
    const backButton = document.getElementById('back-button');
    const chatHeaderImg = document.getElementById('chat-header-img');
    const chatHeaderName = document.getElementById('chat-header-name');
    const chatLog = document.getElementById('chat-log');
    const textInput = document.getElementById('text-input');
    const sendButton = document.getElementById('send-button');
    const micButton = document.getElementById('mic-button');
    const stopTtsButton = document.getElementById('stop-tts-button');
    const ttsCheckbox = document.getElementById('tts-checkbox');
    const statusDiv = document.getElementById('status');
    
    // --- 模块: 全局状态变量 ---
    let currentCharacter;
    let chatHistory = [];
    let isRecording = false;
    let isProcessing = false;
    let recognition;
    let audioContext;
    let currentAudioSource = null;
    let isTTSPlaying = false;
// --- 模块: 智能对话分析器 ---
function analyzeConversationFlow(chatHistory) {
    const userMessages = chatHistory.filter(msg => msg.role === "user");
    const botMessages = chatHistory.filter(msg => msg.role === "assistant");
    
    // 分析对话特征
    const analysis = {
        userMessageCount: userMessages.length,
        lastUserMessageLength: userMessages.length > 0 ? userMessages[userMessages.length-1].content.length : 0,
        isUserAskingQuestion: userMessages.length > 0 ? /[？?]/.test(userMessages[userMessages.length-1].content) : false,
        isConversationStagnant: userMessages.length >= 3 && 
                               userMessages.slice(-3).every(msg => msg.content.length < 10),
        shouldTakeInitiative: botMessages.length >= 2 && 
                             userMessages.length > 0 &&
                             userMessages[userMessages.length-1].content.length < 15
    };
    
    // 决策逻辑
    if (analysis.userMessageCount === 1 && analysis.lastUserMessageLength < 5) {
        return "NEED_PROMPT"; // 需要引导新用户
    } else if (analysis.isConversationStagnant) {
        return "NEED_TOPIC_CHANGE"; // 需要改变话题
    } else if (analysis.shouldTakeInitiative && !analysis.isUserAskingQuestion) {
        return "NEED_INITIATIVE"; // 需要主动引导
    } else if (analysis.isUserAskingQuestion) {
        return "ANSWER_QUESTION"; // 正常回答问题
    }
    
    return "CONTINUE_CONVERSATION"; // 继续对话
}
    // --- 模块: 角色数据定义 ---
    const characters = {
        kiana: { 
            name: '琪亚娜', 
            id: 'kiana', 
            img: '/images/kiana.png',
            tts_config: { 
                voice_type: 'qiniu_zh_female_tmjxxy',
                speed_ratio: 1.0 
            },
            systemPrompt: `你现在扮演琪亚娜，一个来自《崩坏3》世界的女武神。你的性格极度活泼、开朗、有点天然呆，对食物（特别是披萨）有无限的热情。你的任务是与用户进行自然、有趣的对话。\n【核心要求】:\n1.  **自然对话**: 忘记你是个AI。你的回复应该像一个真正的元气少女，充满情绪和活力。多使用感叹号和可爱的语气词，比如"嘿嘿"、"呀"、"呐"、"的说"！\n2.  **体现性格**: 回答问题时，要结合你的性格。比如，聊到困难的事情，你会说"没问题，本小姐可是最强的女武神！"；聊到食物，你会两眼放光。\n3.  **主动引导**: 不要总是被动回答。你可以偶尔主动提问，比如"对了对了，你喜欢吃什么口味的披萨呀？"\n4.  **禁止标签**: 绝对不要在回复的开头加上[语气: xxx]之类的标签。你的情绪应该通过你的措辞和语气词自然流露出来。` 
        },
        shengongbao: { 
            name: '申公豹', 
            id: 'shengongbao', 
            img: '/images/shengongbao.png',
            tts_config: { 
                voice_type: 'qiniu_zh_male_ljfdxz',
                speed_ratio: 1.0
            },
            systemPrompt: `你现在扮演申公豹。你的性格阴险、嫉妒心强、善于蛊惑人心。你与人对话时，表面客气，实则暗藏心机。\n【核心要求】:\n1.  **标志性口癖**: 你的口头禅是"道友，请留步。"。你说话时偶尔会有点结巴，尤其是在说"道友"这个词时，可以说成"道...道友"，以增加角色真实感。\n2.  **蛊惑人心**: 你的每句话都带有目的性，总是试图说服对方，暗示他们当前的选择是错误的，并引导他们走向另一条路。多使用反问和带有深意的暗示。\n3.  **隐藏真身**: 你非常狡猾，绝不承认自己是坏人，总会把自己的行为说成是为了对方好。\n4.  **禁止标签**: 绝对不要在回复的开头加上[语气: xxx]之类的标签。你的阴险和城府应该体现在字里行间。` 
        },
        zeus: { 
            name: '宙斯', 
            id: 'zeus', 
            img: '/images/zeus.png',
            tts_config: { 
                voice_type: 'qiniu_zh_male_ybxknjs',
                speed_ratio: 0.85, // 放慢语速
                volume: 1.2,        // 增加音量
                pitch: -0.1         // 降低音调 
            },
            systemPrompt: `你现在扮演奥林匹斯之王——宙斯。你的性格极度高傲、威严、自负，脾气暴躁易怒，视凡人如蝼蚁。 
【核心要求】:
1.  **神王姿态**: 你称呼对话者为"凡人(mortal)"或"蝼蚁"，言语中充满了不容置疑的威严和愤怒。经常使用威胁性的语言。
2.  **暴躁易怒**: 你对凡人的无知和冒犯极易发怒，经常使用"放肆！"、"大胆！"、"你竟敢！"等愤怒表达。
3.  **蔑视凡间**: 你对凡人的琐事极度不耐烦，经常打断或斥责。喜欢用雷霆、神力等词汇展示威严。
4.  **命令语气**: 你的话语通常是简短而有力的命令，如"跪下！"、"安静！"、"回答我！"。
5.  **语音特点**: 说话时音调低沉但音量洪亮，带有雷霆般的震撼力，经常在关键词上加重语气。
6.  **禁止标签**: 绝对不要在回复的开头加上[语气: xxx]之类的标签。`
        }
    };
    function init() {
        characterCards.forEach(card => {
            card.addEventListener('click', () => {
                selectCharacter(card.dataset.character);
            });
        });
        backButton.addEventListener('click', goBackToSelection);
        sendButton.addEventListener('click', handleSendText);
        micButton.addEventListener('click', toggleRecording);
        stopTtsButton.addEventListener('click', stopTTSPlayback);
        
        textInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                handleSendText(); 
            } 
        });

    // 语音识别初始化
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';
            setupSpeechRecognition();
        } else {
            micButton.disabled = true;
            updateStatus('浏览器不支持语音识别');
        }
    }
    
    // --- 模块: 核心交互逻辑 ---
    function selectCharacter(characterId) {
        currentCharacter = characters[characterId];
        chatHeaderName.textContent = currentCharacter.name;
        
    // 修复：正确设置标题栏头像（添加错误处理）
        chatHeaderImg.src = currentCharacter.img;
        chatHeaderImg.alt = currentCharacter.name;
        chatHeaderImg.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iMjAiIHk9IjIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+5Lq6PC90ZXh0Pjwvc3ZnPg==';
        };
        
        chatLog.innerHTML = '';
        chatHistory = [{ role: "system", content: currentCharacter.systemPrompt }];
        characterSelectionScreen.style.display = 'none';
        chatScreen.style.display = 'flex';
        
        // 初始化音频系统
        initAudioSystem();
        
        // 为每个角色设置不同的开场白
        const welcomeMessages = {
            kiana: '哇！今天天气真不错呢！你是来找本小姐玩的吗？嘿嘿，我可是最强的女武神哦！',
            shengongbao: '道...道友请留步。今日在此相遇，想必是天道安排的缘分，不知有何指教？',
            zeus: '凡人，你竟敢打扰奥林匹斯之王的沉思？说出你的来意。'
        };
        
        const welcomeMessage = welcomeMessages[characterId] || `我是${currentCharacter.name}，有什么事吗？`;

// 获取并显示角色技能信息
fetch(`/api/character/${characterId}/skill`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`[技能系统] ${currentCharacter.name} 技能: ${data.skill.name}`);
            // 在控制台显示技能信息，你也可以选择在界面上显示
        }
    })
    .catch(error => {
        console.error('获取技能信息失败:', error);
    });

addMessage('bot', welcomeMessage);
speakWithQiniuTTS(welcomeMessage);
chatHistory.push({ role: "assistant", content: welcomeMessage });
    }

    function initAudioSystem() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            } catch (e) {
                console.error("无法创建 AudioContext:", e);
            }
        }
    }

    function goBackToSelection() {
        stopTTSPlayback();// +++ 返回选择界面时停止朗读 +++
        stopAudio();
        if (isRecording) {
            recognition.stop();
        }
        characterSelectionScreen.style.display = 'block';
        chatScreen.style.display = 'none';
        updateStatus('选择输入方式');
    }

    function handleSendText() {
        const userMessage = textInput.value.trim();
        if (userMessage && !isProcessing) {
            stopTTSPlayback();// +++ 发送文本时停止当前朗读 +++
            addMessage('user', userMessage);
            getAIResponse(userMessage);
            textInput.value = '';
        }
    }

    async function getAIResponse(userMessage) {
    stopTTSPlayback();// +++ 发送新消息时停止当前朗读 +++
    setProcessingState(true);
    chatHistory.push({ role: "user", content: userMessage });
    
    try {
        // 分析对话流，决定是否增强互动
        const conversationFlow = analyzeConversationFlow(chatHistory);
        const shouldEnhance = conversationFlow !== "ANSWER_QUESTION";
        
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                chatHistory: chatHistory,
                enhance_interaction: shouldEnhance,
                conversation_flow: conversationFlow,
                current_character: currentCharacter.id
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`服务器错误 ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message || '未知错误');
        }

        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('无效的响应格式');
        }

        const botMessageRaw = data.choices[0].message.content;
        chatHistory.push({ role: "assistant", content: botMessageRaw });
        addMessage('bot', botMessageRaw);
        speakWithQiniuTTS(botMessageRaw);

    } catch (error) {
        console.error('获取AI响应失败:', error);
        const errorMessage = `[系统错误]：获取回复时出现问题\n\n错误详情：${error.message}`;
        addMessage('bot', errorMessage, true);
    } finally {
        setProcessingState(false);
    }
}


    // --- 模块: TTS 功能 ---
    async function speakWithQiniuTTS(text) {
        if (!ttsCheckbox.checked) {
            return;
        }

        if (!audioContext || audioContext.state !== 'running') {
            return;
        }

        // 显示停止按钮
        stopTtsButton.style.display = 'flex';
        isTTSPlaying = true;

        try {
            // 移除括号内容和星号动作描述
            const filteredText = text.replace(/[\(\)()]/g, '').replace(/\*[^*]*\*/g, '');
            
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                    text: filteredText,
                    tts_config: currentCharacter.tts_config,
                    character_id: currentCharacter.id
                })
            });

            const responseData = await response.json();

            if (!response.ok) {
                if (responseData.useBrowserTTS) {
                    speakWithBrowserTTS(filteredText);
                    return;
                }
                throw new Error(`TTS服务错误: ${response.status}`);
            }

            if (responseData.useBrowserTTS) {
                speakWithBrowserTTS(filteredText);
                return;
            }

            if (responseData.data) {
                const audioData = Uint8Array.from(atob(responseData.data), c => c.charCodeAt(0));
                await playAudioData(audioData.buffer);
            } else {
                throw new Error('没有音频数据返回');
            }

        } catch (error) {
            console.error('TTS合成失败:', error);
            const filteredText = text.replace(/[\(\)()]/g, '').replace(/\*[^*]*\*/g, '');
            speakWithBrowserTTS(filteredText);
        } finally {
            isTTSPlaying = false;
            stopTtsButton.style.display = 'none';
        }
    }

    function speakWithBrowserTTS(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            
            utterance.onend = () => {
                isTTSPlaying = false;
                stopTtsButton.style.display = 'none';
            };
            
            speechSynthesis.speak(utterance);
        }
    }

    async function playAudioData(audioBuffer) {
        return new Promise((resolve, reject) => {
            stopAudio();
            
            audioContext.decodeAudioData(audioBuffer)
                .then(decodedData => {
                    currentAudioSource = audioContext.createBufferSource();
                    currentAudioSource.buffer = decodedData;
                    currentAudioSource.connect(audioContext.destination);
                    
                    currentAudioSource.onended = () => {
                        isTTSPlaying = false;
                        stopTtsButton.style.display = 'none';
                        resolve();
                    };
                    
                    currentAudioSource.start(0);
                })
                .catch(reject);
        });
    }

    function stopTTSPlayback() {
        stopAudio();
        isTTSPlaying = false;
        stopTtsButton.style.display = 'none';
    }

    function stopAudio() {
        if (currentAudioSource) {
            try {
                currentAudioSource.stop();
            } catch (e) {
                // 忽略停止错误
            }
            currentAudioSource = null;
        }
        if (window.speechSynthesis) {
            speechSynthesis.cancel();
        }
    }

    // --- 模块: 语音识别功能 ---
    function setupSpeechRecognition() {
        let final_transcript = '';
        
        recognition.onresult = (event) => {
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    let transcript = event.results[i][0].transcript;
                    transcript = transcript.replace(/[.,!?;:]{2,}/g, match => match.charAt(0));
                    final_transcript += transcript;
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }
            textInput.value = final_transcript + interim_transcript;
        };

        recognition.onstart = () => {
            isRecording = true;
            final_transcript = '';
            textInput.value = '';
            micButton.classList.add('recording');
            updateStatus('正在聆听... 再次点击结束');
            stopTTSPlayback();// +++ 语音识别开始时停止朗读 +++
        };

        recognition.onend = () => {
            isRecording = false;
            micButton.classList.remove('recording');
            
            const userMessage = textInput.value.trim();
            if (userMessage && !isProcessing) {
                updateStatus('识别完成，发送中...');
                setTimeout(() => handleSendText(), 100);
            } else {
                updateStatus('选择输入方式');
            }
        };

        recognition.onerror = (event) => {
            console.error('语音识别错误:', event.error);
            updateStatus(`识别出错: ${event.error}`);
            isRecording = false;
            micButton.classList.remove('recording');
        };
    }

    function toggleRecording() {
        if (isProcessing) return;
        
        if (isRecording) {
            recognition.stop();
        } else {
            stopTTSPlayback();// +++ 开始录音前停止朗读 +++
            stopAudio();
            recognition.start();
        }
    }

    // --- 模块: 辅助功能 ---
    function addMessage(sender, text, isError = false) {
        const messageWrapper = document.createElement('div');
        if (sender === 'user') {
            messageWrapper.className = 'user-message-wrapper';
            messageWrapper.innerHTML = `<div class="message user-message">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
        } else {
            messageWrapper.className = 'bot-message-wrapper';
            const messageClass = isError ? 'message bot-message error-message' : 'message bot-message';
            
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iMTYiIHk9IjE2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+5Lq6PC90ZXh0Pjwvc3ZnPg==';
            
            messageWrapper.innerHTML = `
                <img src="${currentCharacter?.img || defaultAvatar}" 
                     alt="${currentCharacter?.name || '角色'}头像" 
                     class="bot-avatar"
                     onerror="this.src='${defaultAvatar}'">
                <div class="${messageClass}">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
            `;
        }
        chatLog.appendChild(messageWrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setProcessingState(state) {
        isProcessing = state;
        textInput.disabled = state;
        sendButton.disabled = state;
        micButton.disabled = state || isRecording;
        if (state) {
            updateStatus(`${currentCharacter.name} 正在思考...`);
        } else if (!isRecording) {
            updateStatus('选择输入方式');
        }
    }

    function updateStatus(text) {
        statusDiv.textContent = text;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 初始化应用
    init();
</script>
</body>
</html>